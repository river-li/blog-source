这本书的前4章内容，主要介绍了一些基本的方法

pefile是Python的一个库，可以用来操作Exe文件

这里的内容主要是看*Malware Data Science*记的笔记


<!--more-->


## Basic Static Malware Analysis

PE文件的格式如图

![1.png][1]

之前都学过，就不怎么说了

```python
import pefile
pe = pefile.PE("ircbot.exe")
for entry in pe.DIRECTORY_ENTRY_IMPORT:
    print(entry.dll)
    for function in entry.imports:
        print('\t'+function.name)
```

使用pefile这个库打印PE文件导入的dll以及相应的函数


## X86 Disassembly

这里还有一个库`capstone`

这是一个开源的反汇编库

首先是导入库

```python
import pefile
import capstone
```

加载PE文件的方法从前一节可以得知

```python
pe = pefile.PE(filename)
```

一般情况获取到PE文件首先要看入口地址，读取入口地址的函数：

```python
entrypoint = pe.OPTIONAL_HEADER.AddressOfEntryPoint
entrypoint_address = entrypoint + pe.OPTIONAL_HEADER.ImageBase
```

由于入口地址在可选文件头部分，因此也比较容易理解这个接口

不过我们知道PE文件里写的入口地址没有加上`ImageBase`,因此实际的地址还要加上这个

读取出文件中的二进制的方法：

```python
binary_code = pe.get_memory_mapped_image()
```

读出来的是一个Bytes结构

下面就涉及另一个库的用法了

读出文件的二进制之后我们希望能得到汇编的代码

```python
disassembler = capstone.Cs(CS_ARCH_x86, CS_MODE_32)
for instruction in disassembler.disasm(binary_code, entrypoint_address):
    print("%s\t%s",instruction.mnemonic, instruction.op_str)
```

首先声明了一个反汇编器，需要指定相应的架构

之后使用这个汇编器的`disasm`方法就可以反汇编出相应的代码

不过有一些程序有反汇编的机制，比如动态的修改自身代码等等

这种情况下就不是很容易得到正确结果，只有动态调试才比较可行


## Dynamic Analysis

恶意软件的分析一般要分为静态分析和动态分析

动态分析的过程需要实际的运行

典型的恶意软件行为：

- 修改文件系统
- 修改Windows注册表或系统配置
- 网络操作
- 加载设备驱动（例如Keylogger）

这里书里推荐了一个网站[malwr.com](malwr.com)

基本的动态分析也有一些缺陷

比如有的程序会检测自身是否处于虚拟环境中

是的话就不会释放恶意代码

还有一些行为比如连接了远程服务器后等待接受指令

但远程的控制服务器一直没有发指令过来，这个过程的分析就无法分析会有哪些行为


## Malware Network Analysis

将每一个独立的Malware视为一个节点，将他们之间的关系视为边

这里的边包含共享代码的关系以及网络行为上的关联

之后可以得到一个图

IP地址也可以作为一个点

这样IP地址或域名以及Malware可以构成一个二分图

溯源时可以根据这样的原理来找到相同攻击者的样本

当图中的节点数目比较大时，图中的节点分布可能比较乱，并且难以合理规划位置

可以使用力导向布局算法简化图的构造

这个算法原理就是模拟物理世界中弹簧受力

在拉或者推弹簧时都会有一个趋向原本长度的力


构造网络用的一个库:`NetworkX`

```python
import networkx
network = networkx.Graph()

nodes = ["hello",1,2,3]

for node in nodes:
    network.add_node(node)

network.add_edge(1,2)
network.add_edge(1,3)
network.add_edge(1,"hello")

networkx.drawing.nx_agraph.write_dot(network,"network.dot")
```

上面就是构造图的基本方法

当需要为节点或边添加额外的属性时只需要在后面加属性即可
例如：

```python
network.add_node(1,myattribute="foo")
network.add_edge("node1","node2",myattribute="fish")
```

需要网络可视化时可以使用`GraphViz`

这是一个软件包，linux下面可以直接安装

```bash
pacman -S graphviz
```

用法：

```bash
neato/sfdp/fdp network.dot -T png -o network.png
```

fdp的意思是绘制成`force-directed picture`,即前面说的力导向图

sfdp 是绘制`supernodes`的fdp

neato是另一种图，包含了无连接节点的图

在画图前也可以直接在networkx中设置一些图的属性

比如节点的颜色、形状、边的宽度等

也可以直接在图中添加一些标签

书里还附带了几个脚本提取PE文件中的Host并且构造出图

这里放上一个有点用的提取Host的函数

```python
def find_hostnames(string):
    possible_hostnames = re.findall(r'(?:[a-zA-Z0-9](?:[a-zA-Z0-9\-]{,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,6}',string)
    valid_hostnames = filter(
    lambda hostname: hostname.split(".")[-1].lower() in valid_hostname_suffixes, possible_hostnames
    )
    return valid_hostnames
    
```


[1]: http://42.193.111.59/usr/uploads/2021/01/1739269507.png#vwid=553&vhei=490