## introduction

### Glibc

`ldd`是list dymic dependencies，可以显示出二进制程序运行时需要加载的动态链接库

libc是linux中最基本的动态链接库，绝大多数程序都需要用到libc，如果删除libc的链接，关机都会关不掉；

### malloc

堆是程序在执行中可以使用malloc向内核请求一段连续的内存空间；

I/O、文件读写等等都是通过堆来实现的；



## The House of Force

### 堆与malloc

首先需要对堆有一个基本的理解，堆通过malloc分配chunk，通过free来释放chunk

首先是一个demo例子用于理解堆

在pwndbg中执行

```
set context-sections code
```

这样可以让之后每一次显示context只显示源代码部分

![image-20210217212638040](https://static.hack1s.fun/images/2021/02/17/image-20210217212638040.png)

这个程序主要做的事情就是调用了几次malloc，之后return

`vmmap`可以显示出进程当前的内存空间，在这一句malloc还没有执行的时候，程序内存空间不存在堆的区域

![image-20210217212950029](https://static.hack1s.fun/images/2021/02/17/image-20210217212950029.png)

当第一次malloc执行之后，查看vmmap会发现多出来了一个堆的空间

![image-20210217213700269](https://static.hack1s.fun/images/2021/02/17/image-20210217213700269.png)

在pwndbg中的命令`vis_heap_chunk`简写为`vis`可以查看堆的chunk分布

![image-20210217214128093](https://static.hack1s.fun/images/2021/02/17/image-20210217214128093.png)

我们虽然是执行了`malloc(9)`，申请了9的空间，但是实际上给了我们3*8=24字节的空间（蓝色部分的第一个8字节是头部，不是用户可以用的）

也就是说`malloc(9)`分配给了24字节的user data以及8个字节的meta data，这个chunk一共占了32字节；

`malloc`分配的最小chunk就是这样0x20的大小，即24字节的user data和8个字节的meta data

即使执行的是`malloc(0)`、`malloc(1)`仍然会分配一个0x20大小的chunk

![image-20210217214720913](https://static.hack1s.fun/images/2021/02/17/image-20210217214720913.png)

图中几个chunk分别是`malloc(9)`、`malloc(1)`、`malloc(0)`、`malloc(24)`分配的；

可以看到实际上内容都是一样的占了0x20字节；

但是也可以注意到，其中meta data部分并不是存储了0x20，而是0x21；

这是因为meta data这里两个字段，一是chunk size，表示整个chunk（包含user和meta两部分）的大小，另外由于chunk分配时是按照16字节对齐的，最低位就可以用来表示其他信息；这个字段就是previous_inuse，用来表示这一个chunk相邻的前一个chunk是否是在使用的状态，如果是就为1，否则为0；

下面如果继续执行`malloc(25)`会分配一个0x30的空间

![image-20210217215150684](https://static.hack1s.fun/images/2021/02/17/image-20210217215150684.png)

虽然最后16个字节只用到了1个字节，但还是按照16字节对齐进行分配的。

最后就是Top chunk，可以看到在我们自己申请的Chunk之后有一个Top Chunk的meta data；

并且随着一次次的申请新的堆空间，这个Top Chunk的大小会发生变化。

这是因为内核在分配堆的内存空间时是创建一块大的Top Chunk，每一次用户执行的malloc就是压缩top chunk分配给用户，直到Top Chunk的空间不足以分配，就会再向下拓展Top Chunk

![image-20210217221525951](https://static.hack1s.fun/images/2021/02/17/image-20210217221525951.png)

在Top Chunk中有一个值得注意的地方是，在Glibc的很多版本中，Top Chunk的Size字段都是没有完整性检查的，这就是The House of Force的基本原理



在2005年，第一次出现了一篇名为The Malloc Maleficarum的论文，其中写了5种堆利用的技巧；

1. Houses of Prime
2. Houses of Mind
3. Houses of Force
4. Houses of Lore
5. Houses of Spirit

从此之后的堆利用技巧也因此都叫"house of  XX"这样的形式 