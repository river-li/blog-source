安恒HWS2021冬令营讲的是物联网漏洞挖掘相关的内容

这是学习中的一些笔记；



## 物联网渗透实战思路

物联网设备层次模型

- 物理感知层（固件提取、硬件攻击）
- 通信层（流量监听、中间人攻击）
- 管理控制层/应用层（web、rtsp、ssh...）



物联网设备通信模型

- 云端安全风险
- 客户端（APP）安全风险
- 设备自身安全风险

云端可以采用常规的渗透测试思路进行信息搜集；

客户端的话一般可以使用逆向分析apk的方法；

设备自身的问题，一般着眼于设备本身开启了哪些服务、功能等；



### 信息收集

- 端口扫描
    - 从设备外部进行扫描（nmap、nessus）
    - 从设备上的shell查看链接（`netstat -anltu`）
- 流量抓取、分析
    - 外部嗅探；
        - wireshark、tcpdump
        - 交换机镜像端口
    - 内部调试，通信协议一般是从UART的TX口出来；
- 功能点评估；



> netstat得到的端口有的是`0.0.0.0`的，这样的是可以从外部访问到的；
>
> 另外有时候会有端口开放在`127.0.0.1`等内部的地址，这些就无法从外面进行访问；
>
> 另外流量分析，经常需要编译一个静态链接的二进制tcpdump传到文件系统中，之后再抓包；



端口扫描中除了常规的端口扫描`nmap -Pn 192.168.0.1`这样

还可以指定udp扫描，因为经常有一些私有的协议不是在常规的端口开放

`nmap -sV -sU -Pn --open 192.168.0.1`



### 物联网设备漏洞点分析

设备功能中比较敏感的部分；

例如路由器有时会有网络诊断的功能，这时有可能是输入一个地址来执行`ping`和`traceroute`等，这里有可能出现命令执行；

另外导出配置文件也是比较敏感的功能，有可能可以抓包重放达到不需要认证就获取到配置文件的效果；



通用来说，比较常见的切入点

- 基于Web安全的漏洞
- 逻辑漏洞
- 基于固件的二进制漏洞
- 后门漏洞
- 云端安全风险
- 基于通信/私有协议的漏洞风险

> 很多厂商可能会开启为了方便调试的接口或是协议，这些都是有可能有危险的



#### Web安全漏洞

##### 认证绕过

- 敏感路径不需要认证
- Cookie伪造
- 其他奇怪姿势

> 案例：
>
> D-Link 850L
>
> 攻击者可恶意伪造全局变量的值
>
> 
>
> 案例：
>
> D-Link DCS-2530L
>
> 攻击者可以访问未认证的敏感路径
>
> config/getuser?index=0
>
> 访问这个页面就可以直接获取到用户名密码，之后就可以直接控制摄像头
>
> 
>
> 案例：
>
> Tenda系列路由器前台未授权
>
> 本身是为了前端访问静态资源速度更快，使得`.css/.js/.png/.gif`这些资源不需要认证；
>
> 但是这样导致在访问页面时直接在后面加一个后缀就可以绕过认证
>
> `/goform/reboot?.css`
>
> 
>
> 案例：
>
> rtsp服务未授权访问，这是摄像头中常用到的视频实时流传输协议，一般开放在554端口
>
> 再拿到了路径之后，一般就可以直接用VLC访问摄像头的数据，不需要认证
>
> `rtsp://xx:554/stream1`
>
> `rtsp://xx:554/onvif1`
>
> 后面的这个字符串可以通过IDA逆向分析设备固件中的字符串得到
>
> 另外也可以在网上搜到一些厂商的路径



##### 弱密码

- 门槛低
- 黑灰产、僵尸网络使用较多

Github上有一个好项目

[https://github.com/ihebski/DefaultCreds-cheat-sheet](https://github.com/ihebski/DefaultCreds-cheat-sheet)



##### 命令注入

有一些不太常见的命令执行流程

例如

1. `getenv`获取字段
2. `sprintf`将字段添加到buffer
3. `popen`执行`command`



#### 基于固件的二进制漏洞分析

一般通用的研究流程

- 固件获取
- 固件解包
- 提取待分析程序
- 固件分析

常见的漏洞风险就和通用的软件安全类似

- 栈溢出、堆溢出
- 拒绝服务
- 命令执行



##### 栈溢出

案例一D-link DIR-815

http协议的cookie字段存在栈溢出；

核心的流程是

getenv、sprintf到buffer导致溢出



案例二 思科RV110w

在guest_logout.cgi中存在栈溢出

流程和上一个例子其实比较类似，是使用`get_cgi`函数获取变量、之后`sscanf`格式化到字符串中；



##### 拒绝服务

固件代码逻辑验证不足造成指针异常，进而导致服务无法正常访问

一般都是空指针异常导致的；

```
v11 = genenv("HTTP_REFERER");
ptr = strdup(v11);
```

例如这个上面的例子中，获取到`HTTP_REFERER`这个字段后，使用`strdup`在栈上开辟了一块空间；

但是如果HTTP请求中对这个`HTTP_REFERER`为空，就会导致后面运行时可能出现空指针引用，导致出错；



又比如

```C
pcVar5 = strchr(url,'=');
*pcVar5 = 0;
```

这样两句代码，如果url中根本就没有存在`=`，第二句就会产生一个指针非法访问；



##### 后门漏洞

- 服务访问后门
- 调试后门