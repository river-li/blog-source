---
title: FormatString-Pwn
copyright: true
mathjax: true
date: 2020-12-01 17:05:39
tags:
- pwn
- linux
categories:
- Pwn
---

学到的格式化字符串利用方式

<!--more-->

## 格式化字符串

格式化字符串漏洞出现的根本原因在于将可控的变量当作字符串输出；

例如

```c
printf(buf);
```

这样buf内容可控

设置为`%p%p%p%p`就可以读到栈上的内容



## 泄漏内存

### 泄漏栈内存

一般有几个原则

1. 利用` %x` 来获取对应栈的内存，但建议使用 `%p`，可以不用考虑位数的区别。
2. 利用 `%s` 来获取变量所对应地址的内容，只不过有零截断。
3. 利用 `%order$x` 来获取指定参数的值，利用 `%order$s `来获取指定参数对应地址的内容

需要注意的是

`%n$x`这样获取到的是第n+1个参数的hex值



### 任意地址读

任意地址读的方法一般是

1. 确定可控字符串本身的偏移
2. 在字符串中填一个任意的地址，用`%s`读这个地址



确定字符串本身的偏移可以用这个方法

```C
[tag]%p%p%p%p....
```

这样看到什么时候出现这个`[tag]`字符串的ASCII码就可以确定整个字符串的偏移

如果格式化字符串在栈上，那么我们就需要确定格式化字符串的相对偏移，这是因为在函数调用的时候栈指针至少低于格式化字符串地址 8 字节或者 16 字节，两者并不是紧挨着的



## 覆盖内存

覆盖内存的字符串一般都是

```
...[overwrite addr]...%[overwrite offset]$n
```

这样的结构

### 覆盖栈地址

格式化字符串往栈上写数据主要靠的是`%n`，这个格式化字符不输出内容，但是会把已经成功输出的字符个数写入到对应的整形指针参数

主要任务有三个：

1. 确定覆盖地址
2. 确定相对偏移
3. 进行覆盖



确定覆盖地址一般需要首先泄漏出变量的地址，可以先通过构造格式化字符串的读来泄漏

确定相对偏移的方法就是前面任意地址读时用到的，确定出格式化字符串相对函数调用时的栈帧偏移

最后构造字符串覆盖时，需要注意的是前面填充部分的长度，以及地址本身占位的长度。



### 覆盖任意地址

### 覆盖小数字

